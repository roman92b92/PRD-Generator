<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRD Generator â€” AI-powered by Claude</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,600;12..96,700;12..96,800&family=Epilogue:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* â”€â”€â”€ Light Theme (default) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        :root {
            --bg:          #f5f5fb;
            --surface:     #ffffff;
            --raised:      #f0f0f8;
            --border:      #e0e0ec;
            --border-hi:   #c8c8e0;

            --text:        #0d0d1a;
            --muted:       #60608a;
            --dim:         #a8a8c8;

            --out-bg:      #ebebf5;
            --paper:       #ffffff;
            --paper-border: #dddde8;
            --paper-shadow: 0 1px 3px rgba(10,10,40,0.05),
                            0 4px 16px rgba(10,10,40,0.07),
                            0 24px 64px rgba(10,10,40,0.05);

            --accent:      #7c3aed;
            --accent-hi:   #6d28d9;
            --accent-lo:   #9d6ff8;
            --accent-glow: rgba(124,58,237,0.22);
            --accent-dim:  rgba(124,58,237,0.10);
            --accent-ring: rgba(124,58,237,0.22);
            --accent-pale: rgba(124,58,237,0.05);

            --green:       #10b981;
            --green-glow:  rgba(16,185,129,0.40);
            --red:         #ef4444;
            --red-dim:     rgba(239,68,68,0.08);
            --amber:       #f59e0b;

            --nav-bg:      #ffffff;
            --nav-border:  #e8e8f0;

            --tooltip-bg:     #ffffff;
            --tooltip-text:   #0d0d1a;
            --tooltip-border: #d0d0e4;

            --toggle-bg:      rgba(0,0,0,0.05);
            --toggle-border:  #e0e0ec;
            --toggle-icon:    #60608a;

            /* Radii */
            --r-xs: 4px;
            --r-sm: 7px;
            --r:    11px;
            --r-lg: 16px;
            --r-xl: 22px;

            /* Easing */
            --ease:   cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);

            /* Fonts */
            --f-display: 'Bricolage Grotesque', sans-serif;
            --f-body:    'Epilogue', system-ui, sans-serif;
            --f-mono:    'JetBrains Mono', monospace;
        }

        /* â”€â”€â”€ Dark Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        [data-theme="dark"] {
            --bg:          #0b0b11;
            --surface:     #13131c;
            --raised:      #1b1b27;
            --border:      #222232;
            --border-hi:   #333348;

            --text:        #e4e4f0;
            --muted:       #6a6a88;
            --dim:         #35354a;

            --out-bg:      #0e0e18;
            --paper:       #181828;
            --paper-border: #252538;
            --paper-shadow: 0 1px 4px rgba(0,0,0,0.4),
                            0 4px 20px rgba(0,0,0,0.5),
                            0 24px 64px rgba(0,0,0,0.4);

            --accent:      #9d6ff8;
            --accent-hi:   #8b5cf6;
            --accent-lo:   #c4b5fd;
            --accent-glow: rgba(157,111,248,0.32);
            --accent-dim:  rgba(157,111,248,0.14);
            --accent-ring: rgba(157,111,248,0.28);
            --accent-pale: rgba(157,111,248,0.07);

            --green:       #10b981;
            --green-glow:  rgba(16,185,129,0.50);
            --red:         #f87171;
            --red-dim:     rgba(248,113,113,0.10);
            --amber:       #fbbf24;

            --nav-bg:      #0b0b11;
            --nav-border:  #1e1e2e;

            --tooltip-bg:     #2a2a3e;
            --tooltip-text:   #e4e4f0;
            --tooltip-border: rgba(255,255,255,0.10);

            --toggle-bg:      rgba(255,255,255,0.06);
            --toggle-border:  #2a2a3e;
            --toggle-icon:    #9a9ab8;
        }

        /* â”€â”€â”€ Smooth Theme Transitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition:
                background-color 0.28s var(--ease),
                border-color     0.28s var(--ease),
                color            0.18s var(--ease),
                box-shadow       0.28s var(--ease);
        }

        html, body { height: 100%; }

        body {
            font-family: var(--f-body);
            font-size: 14px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg);
            color: var(--text);
        }

        /* â”€â”€â”€ Navbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .navbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 22px;
            height: 52px;
            background: var(--nav-bg);
            border-bottom: 1px solid var(--nav-border);
            position: sticky;
            top: 0;
            z-index: 200;
            flex-shrink: 0;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 11px;
            text-decoration: none;
        }

        .nav-mark {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, var(--accent) 0%, #9333ea 60%, var(--accent-lo) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 16px var(--accent-glow);
            flex-shrink: 0;
            transition: box-shadow 0.28s var(--ease), background 0.28s var(--ease) !important;
        }

        .nav-mark svg {
            width: 15px;
            height: 15px;
            stroke: rgba(255,255,255,0.95);
            fill: none;
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: none !important;
        }

        .nav-wordmark {
            font-family: var(--f-display);
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.025em;
        }

        .nav-wordmark em {
            font-style: normal;
            color: var(--muted);
            font-weight: 500;
        }

        .nav-right { display: flex; align-items: center; gap: 10px; }

        /* â”€â”€â”€ Theme Toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .theme-toggle {
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--toggle-bg);
            border: 1px solid var(--toggle-border);
            border-radius: 50%;
            cursor: pointer;
            color: var(--toggle-icon);
            font-size: 15px;
            line-height: 1;
            transition: background 0.2s, border-color 0.2s, transform 0.2s var(--spring) !important;
            user-select: none;
        }

        .theme-toggle:hover {
            background: var(--accent-dim);
            border-color: var(--accent-ring);
            color: var(--accent);
            transform: rotate(20deg) scale(1.08);
        }

        /* Nav badge */
        .nav-badge {
            display: flex;
            align-items: center;
            gap: 7px;
            font-family: var(--f-mono);
            font-size: 10.5px;
            color: var(--muted);
            background: var(--raised);
            border: 1px solid var(--border);
            padding: 5px 12px;
            border-radius: 100px;
            letter-spacing: 0.01em;
        }

        .live-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--green);
            box-shadow: 0 0 6px var(--green-glow);
            flex-shrink: 0;
            animation: pulse-dot 2.2s ease-in-out infinite;
            transition: none !important;
        }

        @keyframes pulse-dot {
            0%, 100% { box-shadow: 0 0 6px var(--green-glow); }
            50%       { box-shadow: 0 0 14px rgba(16,185,129,0.8); }
        }

        /* â”€â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .layout { display: flex; flex: 1; overflow: hidden; }

        /* â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sidebar {
            width: 408px;
            flex-shrink: 0;
            background: var(--bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar::-webkit-scrollbar { width: 3px; }
        .sidebar::-webkit-scrollbar-track { background: transparent; }
        .sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        .sidebar-header {
            padding: 24px 24px 18px;
            border-bottom: 1px solid var(--border);
            animation: fade-up 0.45s var(--ease) both;
        }

        .sidebar-eyebrow {
            font-family: var(--f-mono);
            font-size: 10px;
            font-weight: 500;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.14em;
            margin-bottom: 5px;
            transition: color 0.18s !important;
        }

        .sidebar-title {
            font-family: var(--f-display);
            font-size: 24px;
            font-weight: 800;
            color: var(--text);
            letter-spacing: -0.04em;
            line-height: 1.1;
        }

        .sidebar-sub {
            font-size: 12.5px;
            color: var(--muted);
            margin-top: 5px;
            line-height: 1.5;
        }

        .sidebar-body { padding: 20px 24px 40px; }

        /* â”€â”€â”€ Form Sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .fsec { margin-bottom: 26px; }

        .fsec:nth-child(1) { animation: fade-up 0.45s 0.06s var(--ease) both; }
        .fsec:nth-child(2) { animation: fade-up 0.45s 0.12s var(--ease) both; }
        .fsec:nth-child(3) { animation: fade-up 0.45s 0.18s var(--ease) both; }
        .fsec:nth-child(4) { animation: fade-up 0.45s 0.24s var(--ease) both; }
        .fsec:nth-child(5) { animation: fade-up 0.45s 0.30s var(--ease) both; }

        .fsec-head {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 13px;
        }

        .fsec-title {
            font-family: var(--f-mono);
            font-size: 10px;
            font-weight: 500;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.12em;
            white-space: nowrap;
        }

        .fsec-rule {
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .badge-opt {
            font-family: var(--f-mono);
            font-size: 9px;
            font-weight: 500;
            color: var(--dim);
            background: var(--raised);
            border: 1px solid var(--border);
            padding: 1px 7px;
            border-radius: 100px;
            white-space: nowrap;
        }

        /* â”€â”€â”€ Template Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .ttabs {
            display: flex;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 4px;
            gap: 2px;
        }

        .ttab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 6px;
            border-radius: var(--r-sm);
            cursor: pointer;
            transition: background 0.2s var(--ease), box-shadow 0.2s !important;
            position: relative;
        }

        .ttab:hover:not(.active) {
            background: var(--raised);
        }

        .ttab.active {
            background: var(--accent);
            box-shadow: 0 2px 14px var(--accent-glow);
        }

        .ttab-icon {
            font-size: 16px;
            line-height: 1;
            transition: transform 0.25s var(--spring) !important;
        }

        .ttab.active .ttab-icon { transform: scale(1.18) translateY(-1px); }

        .ttab-label {
            font-family: var(--f-mono);
            font-size: 9px;
            font-weight: 500;
            color: var(--muted);
            text-align: center;
            line-height: 1.2;
            letter-spacing: 0.04em;
            transition: color 0.2s !important;
        }

        .ttab.active .ttab-label { color: rgba(255,255,255,0.92); }

        /* â”€â”€â”€ Global Tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .g-tooltip {
            position: fixed;
            z-index: 9999;
            background: var(--tooltip-bg);
            color: var(--tooltip-text);
            border: 1px solid var(--tooltip-border);
            font-family: var(--f-body);
            font-size: 12px;
            line-height: 1.55;
            padding: 8px 12px;
            border-radius: var(--r-sm);
            max-width: 230px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.28), 0 1px 4px rgba(0,0,0,0.15);
            pointer-events: none;
            opacity: 0;
            transform: translateY(4px);
            transition: opacity 0.15s, transform 0.15s !important;
        }

        .g-tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Caret below tooltip */
        .g-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: var(--caret-x, 50%);
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--tooltip-bg);
        }

        /* â”€â”€â”€ Form Fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .field { margin-bottom: 12px; }

        .field label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-family: var(--f-mono);
            font-size: 10px;
            font-weight: 500;
            color: var(--muted);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .req { color: var(--accent); font-size: 14px; line-height: 1; transition: color 0.18s !important; }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: var(--f-body);
            font-size: 13px;
            padding: 9px 12px;
            border-radius: var(--r-sm);
            outline: none;
            resize: vertical;
            line-height: 1.55;
        }

        input[type="text"]::placeholder,
        textarea::placeholder {
            color: var(--dim);
            font-size: 12px;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-ring);
            background: var(--accent-pale);
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='11' height='11' viewBox='0 0 24 24' fill='none' stroke='%2360608a' stroke-width='2' stroke-linecap='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 11px center;
            padding-right: 32px;
        }

        [data-theme="dark"] select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='11' height='11' viewBox='0 0 24 24' fill='none' stroke='%236a6a88' stroke-width='2' stroke-linecap='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
        }

        select option { background: var(--surface); color: var(--text); }

        /* â”€â”€â”€ Image Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .upload-zone {
            border: 1.5px dashed var(--border);
            border-radius: var(--r);
            padding: 18px 16px;
            text-align: center;
            cursor: pointer;
            background: var(--raised);
            position: relative;
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: var(--accent-pale);
        }

        .upload-zone.drag-over {
            border-color: var(--accent-lo);
            background: var(--accent-dim);
            box-shadow: 0 0 0 3px var(--accent-ring);
        }

        .upload-zone input[type="file"] {
            position: absolute; inset: 0;
            opacity: 0; cursor: pointer;
            width: 100%; height: 100%;
        }

        .upload-icon  { font-size: 20px; margin-bottom: 6px; display: block; }
        .upload-label { font-size: 12px; font-weight: 500; color: var(--muted); display: block; margin-bottom: 3px; }
        .upload-hint  { font-size: 11px; color: var(--dim); }
        .upload-hint strong { color: var(--accent); font-weight: 500; transition: color 0.18s !important; }

        .upload-counter {
            font-family: var(--f-mono);
            font-size: 10px;
            color: var(--muted);
            margin-top: 9px;
            display: none;
        }

        .upload-counter.visible { display: block; }

        .preview-grid {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 7px;
            margin-top: 10px;
        }

        .preview-grid.visible { display: grid; }

        .preview-item {
            position: relative;
            aspect-ratio: 4/3;
            border-radius: var(--r-sm);
            overflow: hidden;
            border: 1px solid var(--border);
            background: var(--surface);
        }

        .preview-item img { width: 100%; height: 100%; object-fit: cover; display: block; }

        .preview-remove {
            position: absolute; top: 4px; right: 4px;
            width: 18px; height: 18px;
            background: rgba(0,0,0,0.75); color: white;
            border: none; border-radius: 50%; cursor: pointer;
            font-size: 11px; display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.15s !important;
        }

        .preview-item:hover .preview-remove { opacity: 1; }

        .preview-name {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white; font-size: 9px;
            padding: 4px 5px 3px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* â”€â”€â”€ Error Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .err-banner {
            display: none;
            padding: 10px 13px;
            background: var(--red-dim);
            border: 1px solid rgba(239,68,68,0.25);
            border-radius: var(--r-sm);
            color: #dc2626;
            font-size: 12.5px;
            margin-bottom: 16px;
        }

        [data-theme="dark"] .err-banner { color: #fca5a5; }

        .err-banner.on { display: flex; align-items: flex-start; gap: 7px; }

        /* â”€â”€â”€ Generate Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn-gen-wrap {
            animation: fade-up 0.45s 0.36s var(--ease) both;
        }

        .btn-gen {
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, var(--accent) 0%, #9333ea 55%, #7c3aed 100%);
            background-size: 200% 200%;
            animation: btn-gradient 5s ease infinite;
            color: #fff;
            border: none;
            border-radius: var(--r);
            font-family: var(--f-display);
            font-size: 14.5px;
            font-weight: 700;
            letter-spacing: -0.01em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 9px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s var(--spring), box-shadow 0.2s !important;
            box-shadow: 0 4px 22px var(--accent-glow);
        }

        .btn-gen::after {
            content: '';
            position: absolute;
            top: -50%; left: -70%;
            width: 55%; height: 200%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.18), transparent);
            transform: skewX(-18deg);
            transition: left 0.65s var(--ease) !important;
        }

        .btn-gen:not(:disabled):hover::after { left: 130%; }

        @keyframes btn-gradient {
            0%, 100% { background-position: 0% 0%; }
            50%       { background-position: 100% 100%; }
        }

        .btn-gen:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px var(--accent-glow), 0 2px 8px rgba(124,58,237,0.2);
        }

        .btn-gen:not(:disabled):active { transform: translateY(0); }

        .btn-gen:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-gen.generating {
            animation: btn-gradient 5s ease infinite, ring-pulse 1.6s ease-in-out infinite;
        }

        @keyframes ring-pulse {
            0%, 100% { box-shadow: 0 4px 22px var(--accent-glow); }
            50%       { box-shadow: 0 4px 40px rgba(124,58,237,0.65), 0 0 0 5px var(--accent-ring); }
        }

        /* â”€â”€â”€ Output Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .output-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--out-bg);
        }

        /* â”€â”€â”€ Output Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .out-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            height: 48px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .out-bar-l { display: flex; align-items: center; gap: 10px; }

        .out-label {
            font-family: var(--f-mono);
            font-size: 10.5px;
            font-weight: 500;
            color: var(--dim);
            text-transform: uppercase;
            letter-spacing: 0.12em;
        }

        .status-chip {
            display: none;
            align-items: center;
            gap: 5px;
            font-family: var(--f-mono);
            font-size: 10.5px;
            font-weight: 500;
            padding: 3px 10px;
            border-radius: 100px;
        }

        .status-chip.gen {
            background: var(--accent-dim);
            border: 1px solid var(--accent-ring);
            color: var(--accent);
        }

        .status-chip.done {
            background: rgba(16,185,129,0.10);
            border: 1px solid rgba(16,185,129,0.30);
            color: #059669;
        }

        [data-theme="dark"] .status-chip.done { color: #34d399; }

        .status-chip.has-imgs {
            background: rgba(245,158,11,0.10);
            border: 1px solid rgba(245,158,11,0.30);
            color: #d97706;
        }

        [data-theme="dark"] .status-chip.has-imgs { color: #fbbf24; }

        .blink-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: currentColor;
            animation: blink 1.2s ease-in-out infinite;
            transition: none !important;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; transform: scale(1); }
            50%       { opacity: 0.3; transform: scale(0.6); }
        }

        .out-actions { display: flex; gap: 7px; }

        .btn-act {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background: var(--surface);
            border: 1.5px solid var(--border);
            color: var(--muted);
            border-radius: var(--r-sm);
            font-family: var(--f-body);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-act:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-pale);
        }

        .btn-act:disabled { opacity: 0.35; cursor: not-allowed; }
        .btn-act:disabled:hover { border-color: var(--border); color: var(--muted); background: var(--surface); }

        /* â”€â”€â”€ Output Scroll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .out-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 28px 24px;
        }

        .out-scroll::-webkit-scrollbar { width: 5px; }
        .out-scroll::-webkit-scrollbar-track { background: transparent; }
        .out-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 5px; }

        /* â”€â”€â”€ Paper Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .paper {
            background: var(--paper);
            border: 1px solid var(--paper-border);
            border-radius: var(--r-lg);
            box-shadow: var(--paper-shadow);
            max-width: 800px;
            margin: 0 auto;
            min-height: 360px;
            overflow: hidden;
        }

        /* â”€â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 190px);
            padding: 40px 24px;
            text-align: center;
        }

        .empty-glyph {
            font-size: 52px;
            line-height: 1;
            margin-bottom: 22px;
            display: block;
            animation: float 4s ease-in-out infinite;
            filter: drop-shadow(0 6px 16px rgba(124,58,237,0.22));
            transition: none !important;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50%       { transform: translateY(-9px); }
        }

        .empty-head {
            font-family: var(--f-display);
            font-size: 28px;
            font-weight: 800;
            color: var(--text);
            letter-spacing: -0.04em;
            margin-bottom: 10px;
        }

        .empty-body {
            font-size: 14px;
            color: var(--muted);
            line-height: 1.65;
            max-width: 360px;
            margin-bottom: 32px;
        }

        .empty-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
            text-align: left;
            width: 100%;
            max-width: 380px;
        }

        .estep {
            display: flex;
            align-items: center;
            gap: 13px;
            font-size: 13px;
            color: var(--muted);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--r-sm);
            padding: 10px 14px;
            box-shadow: 0 1px 3px rgba(10,10,40,0.04);
        }

        .estep:hover {
            border-color: var(--accent-ring);
            box-shadow: 0 2px 8px var(--accent-dim);
        }

        .estep-n {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--accent-dim);
            border: 1.5px solid var(--accent-ring);
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--f-mono);
            font-size: 10px;
            font-weight: 700;
            flex-shrink: 0;
            transition: color 0.18s, background 0.28s, border-color 0.28s !important;
        }

        /* â”€â”€â”€ Stream View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stream-view {
            display: none;
            padding: 36px 40px;
            font-family: var(--f-mono);
            font-size: 12.5px;
            color: var(--muted);
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 2;
        }

        .stream-view.on { display: block; }

        .cursor {
            display: inline-block;
            width: 2px; height: 14px;
            background: var(--accent);
            vertical-align: text-bottom;
            animation: blink-c 0.72s step-end infinite;
            transition: background 0.18s !important;
        }

        @keyframes blink-c { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* â”€â”€â”€ Markdown View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .md-view { display: none; }
        .md-view.on { display: block; }

        /* â”€â”€â”€ Markdown Typography â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .md {
            color: var(--text);
            font-size: 14.5px;
            line-height: 1.78;
            padding: 36px 40px 52px;
        }

        .md h1 {
            font-family: var(--f-display);
            font-size: 32px;
            font-weight: 800;
            color: var(--text);
            letter-spacing: -0.045em;
            line-height: 1.15;
            margin: 0 0 6px;
        }

        .md h2 {
            font-family: var(--f-display);
            font-size: 19px;
            font-weight: 700;
            color: var(--accent-hi);
            letter-spacing: -0.025em;
            margin: 42px 0 14px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-dim);
        }

        .md h3 { font-size: 15px; font-weight: 600; color: var(--text); margin: 24px 0 9px; }

        .md h4 {
            font-family: var(--f-mono);
            font-size: 11px;
            font-weight: 500;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin: 18px 0 7px;
        }

        .md p { margin: 0 0 13px; }
        .md ul, .md ol { padding-left: 24px; margin: 0 0 13px; }
        .md li { margin-bottom: 6px; }

        .md li input[type="checkbox"] {
            width: 14px; height: 14px;
            margin-right: 7px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .md table {
            width: 100%;
            border-collapse: collapse;
            margin: 18px 0;
            font-size: 13px;
            border-radius: var(--r-sm);
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(10,10,40,0.07);
        }

        .md th {
            background: var(--raised);
            border: 1px solid var(--border);
            padding: 10px 14px;
            text-align: left;
            font-family: var(--f-mono);
            font-size: 10.5px;
            font-weight: 500;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.07em;
        }

        .md td { border: 1px solid var(--border); padding: 10px 14px; vertical-align: top; }
        .md tr:nth-child(even) td { background: var(--raised); }

        .md code {
            font-family: var(--f-mono);
            font-size: 12.5px;
            background: var(--raised);
            border: 1px solid var(--border);
            padding: 1px 6px;
            border-radius: var(--r-xs);
            color: var(--accent-hi);
        }

        .md pre {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 18px 20px;
            overflow-x: auto;
            margin: 16px 0;
        }

        [data-theme="dark"] .md pre { background: #0e0e18; border-color: #1e1e30; }

        .md pre code { background: none; border: none; padding: 0; color: var(--muted); font-size: 12.5px; }
        [data-theme="dark"] .md pre code { color: #a0a0d0; }

        .md blockquote {
            border-left: 3px solid var(--accent);
            padding: 12px 18px;
            margin: 18px 0;
            background: var(--accent-pale);
            border-radius: 0 var(--r-sm) var(--r-sm) 0;
            color: var(--muted);
            font-style: italic;
        }

        .md hr { border: none; border-top: 1.5px solid var(--border); margin: 32px 0; }
        .md strong { color: var(--text); font-weight: 600; }
        .md em { color: var(--accent-hi); font-style: italic; transition: color 0.18s !important; }
        .md a { color: var(--accent); text-decoration: none; transition: color 0.18s !important; }
        .md a:hover { text-decoration: underline; }

        /* â”€â”€â”€ Stats Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stats-bar {
            display: none;
            align-items: center;
            gap: 4px;
            padding: 0 24px;
            height: 33px;
            border-top: 1px solid var(--border);
            background: var(--surface);
            flex-shrink: 0;
            font-family: var(--f-mono);
            font-size: 10.5px;
            color: var(--muted);
        }

        .stats-bar.on { display: flex; }
        .stat-k { color: var(--dim); }
        .stat-sep { color: var(--border); padding: 0 8px; }

        /* â”€â”€â”€ Entrance Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @keyframes fade-up {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<!-- Global tooltip (JS-positioned, avoids overflow clipping) -->
<div class="g-tooltip" id="gTooltip"></div>

<!-- â”€â”€ Navbar â”€â”€ -->
<nav class="navbar">
    <a class="nav-logo" href="#">
        <div class="nav-mark">
            <svg viewBox="0 0 24 24">
                <rect x="3" y="3" width="18" height="3" rx="1"/>
                <rect x="3" y="8.5" width="13" height="3" rx="1"/>
                <rect x="3" y="14" width="16" height="3" rx="1"/>
                <rect x="3" y="19.5" width="10" height="2.5" rx="1"/>
            </svg>
        </div>
        <span class="nav-wordmark">PRD <em>Generator</em></span>
    </a>
    <div class="nav-right">
        <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle dark mode" aria-label="Toggle theme">
            <span id="themeIcon">ğŸŒ™</span>
        </button>
        <div class="nav-badge">
            <div class="live-dot"></div>
            Powered by Claude API
        </div>
    </div>
</nav>

<!-- â”€â”€ Layout â”€â”€ -->
<div class="layout">

    <!-- â”€â”€ Sidebar â”€â”€ -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-eyebrow">New Document</div>
            <div class="sidebar-title">Create a PRD</div>
            <div class="sidebar-sub">Describe your product and let Claude write the full document.</div>
        </div>

        <div class="sidebar-body">

            <div class="err-banner" id="errBanner">
                <span>âš </span>
                <span id="errMsg"></span>
            </div>

            <!-- Template -->
            <div class="fsec">
                <div class="fsec-head">
                    <span class="fsec-title">Template</span>
                    <div class="fsec-rule"></div>
                </div>
                <div class="ttabs">
                    <div class="ttab active" data-format="standard" onclick="selectTpl(this)"
                         data-tip="Full 11-section PRD â€” executive summary, tech specs, go-to-market strategy, risks, and timeline. Best for complex features or 6+ week projects.">
                        <span class="ttab-icon">ğŸ“‹</span>
                        <span class="ttab-label">Standard</span>
                    </div>
                    <div class="ttab" data-format="one_page" onclick="selectTpl(this)"
                         data-tip="Concise single-page format covering problem, solution, scope, risks, and timeline. Great for quick stakeholder alignment on smaller features.">
                        <span class="ttab-icon">ğŸ“„</span>
                        <span class="ttab-label">One-Page</span>
                    </div>
                    <div class="ttab" data-format="agile_epic" onclick="selectTpl(this)"
                         data-tip="Sprint-based epic with user story map, sprint breakdown, acceptance criteria, and definition of done. Perfect for agile teams.">
                        <span class="ttab-icon">ğŸƒ</span>
                        <span class="ttab-label">Agile Epic</span>
                    </div>
                    <div class="ttab" data-format="feature_brief" onclick="selectTpl(this)"
                         data-tip="Hypothesis-driven exploration brief for early-stage ideas. Ideal for discovery work before committing to a full build.">
                        <span class="ttab-icon">ğŸ’¡</span>
                        <span class="ttab-label">Feature Brief</span>
                    </div>
                </div>
            </div>

            <!-- Product details -->
            <div class="fsec">
                <div class="fsec-head">
                    <span class="fsec-title">Product details</span>
                    <div class="fsec-rule"></div>
                </div>

                <div class="field">
                    <label>Product / Feature Name <span class="req">*</span></label>
                    <input type="text" id="f_name" placeholder="e.g. Smart Notification Center" />
                </div>

                <div class="field">
                    <label>Problem Statement <span class="req">*</span></label>
                    <textarea id="f_problem" rows="3"
                        placeholder="What problem are you solving? Who is affected and why does it matter?"></textarea>
                </div>

                <div class="field">
                    <label>Target Users <span class="req">*</span></label>
                    <textarea id="f_users" rows="2"
                        placeholder="e.g. Enterprise admins, power users, mobile consumersâ€¦"></textarea>
                </div>

                <div class="field">
                    <label>Proposed Solution <span class="req">*</span></label>
                    <textarea id="f_solution" rows="3"
                        placeholder="What are you building? How does it solve the problem?"></textarea>
                </div>

                <div class="field">
                    <label>Business Goals &amp; Expected Impact</label>
                    <textarea id="f_goals" rows="2"
                        placeholder="e.g. Increase retention 20%, reduce churn from 8% â†’ 4%â€¦"></textarea>
                </div>

                <div class="field">
                    <label>Timeline</label>
                    <input type="text" id="f_timeline" placeholder="e.g. Q3 2026, 12 weeks" />
                </div>

                <div class="field">
                    <label>Additional Context</label>
                    <textarea id="f_context" rows="2"
                        placeholder="Platform constraints, compliance notes, stakeholder requirementsâ€¦"></textarea>
                </div>
            </div>

            <!-- Visual references -->
            <div class="fsec">
                <div class="fsec-head">
                    <span class="fsec-title">Visual References</span>
                    <span class="badge-opt">optional</span>
                    <div class="fsec-rule"></div>
                </div>

                <div class="upload-zone" id="uploadZone">
                    <input type="file" id="imageInput" accept="image/jpeg,image/png,image/gif,image/webp" multiple />
                    <span class="upload-icon">ğŸ–¼ï¸</span>
                    <span class="upload-label">Drop mockups &amp; wireframes here</span>
                    <span class="upload-hint">or <strong>click to browse</strong> Â· JPG, PNG, WebP Â· max 5MB each</span>
                </div>

                <div class="upload-counter" id="uploadCounter"></div>
                <div class="preview-grid" id="previewGrid"></div>
            </div>

            <!-- Model -->
            <div class="fsec">
                <div class="fsec-head">
                    <span class="fsec-title">Claude Model</span>
                    <div class="fsec-rule"></div>
                </div>
                <select id="f_model">
                    <option value="claude-sonnet-4-6">claude-sonnet-4-6 â€” Recommended</option>
                    <option value="claude-opus-4-6">claude-opus-4-6 â€” Most powerful</option>
                    <option value="claude-haiku-4-5-20251001">claude-haiku-4-5-20251001 â€” Fastest</option>
                </select>
            </div>

            <div class="btn-gen-wrap">
                <button class="btn-gen" id="genBtn" onclick="generate()">
                    <span id="genIcon">â–¶</span>
                    <span id="genLabel">Generate PRD</span>
                </button>
            </div>

        </div>
    </aside>

    <!-- â”€â”€ Output Panel â”€â”€ -->
    <div class="output-panel">

        <!-- Toolbar -->
        <div class="out-bar">
            <div class="out-bar-l">
                <span class="out-label">Output</span>
                <div class="status-chip gen" id="chipGen">
                    <span class="blink-dot"></span> Generating
                </div>
                <div class="status-chip done" id="chipDone">
                    <span>âœ“</span> Complete
                </div>
                <div class="status-chip has-imgs" id="chipImgs" style="display:none"></div>
            </div>
            <div class="out-actions">
                <button class="btn-act" id="btnCopy" onclick="copyMd()" disabled>
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                    Copy Markdown
                </button>
                <button class="btn-act" id="btnDl" onclick="downloadMd()" disabled>
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Download .md
                </button>
            </div>
        </div>

        <!-- Scroll area -->
        <div class="out-scroll" id="outScroll">

            <!-- Empty state -->
            <div class="empty" id="emptyState">
                <span class="empty-glyph">ğŸ“‹</span>
                <div class="empty-head">Your PRD will appear here</div>
                <div class="empty-body">
                    Fill in your product details, optionally upload wireframes or mockups, then click Generate â€” your PRD streams word by word in real-time.
                </div>
                <div class="empty-steps">
                    <div class="estep"><div class="estep-n">1</div><span>Choose a PRD template type</span></div>
                    <div class="estep"><div class="estep-n">2</div><span>Describe your product, users, and goals</span></div>
                    <div class="estep"><div class="estep-n">3</div><span>Upload mockups / wireframes (optional â€” improves quality)</span></div>
                    <div class="estep"><div class="estep-n">4</div><span>Click Generate â€” streams word by word via Claude API</span></div>
                </div>
            </div>

            <!-- Paper card: streaming + rendered markdown -->
            <div class="paper" id="paperWrap" style="display:none">
                <div class="stream-view" id="streamView"></div>
                <div class="md-view" id="mdView">
                    <div class="md" id="mdContent"></div>
                </div>
            </div>

        </div>

        <!-- Stats bar -->
        <div class="stats-bar" id="statsBar">
            <span class="stat-k">chars</span>&nbsp;<span id="sChars">0</span>
            <span class="stat-sep">Â·</span>
            <span class="stat-k">words</span>&nbsp;<span id="sWords">0</span>
            <span class="stat-sep">Â·</span>
            <span class="stat-k">time</span>&nbsp;<span id="sTime">â€”</span>
            <span class="stat-sep">Â·</span>
            <span class="stat-k">model</span>&nbsp;<span id="sModel">â€”</span>
            <span class="stat-sep">Â·</span>
            <span class="stat-k">images</span>&nbsp;<span id="sImgs">0</span>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked@9/marked.min.js"></script>
<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
marked.setOptions({ gfm: true, breaks: false });

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let fmt            = 'standard';
let markdown       = '';
let busy           = false;
let t0             = null;
let uploadedImages = [];

// â”€â”€ DOM helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $   = id => document.getElementById(id);
const val = id => $(id).value.trim();

// â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme() {
    const isDark = document.documentElement.dataset.theme === 'dark';
    const next   = isDark ? 'light' : 'dark';
    document.documentElement.dataset.theme = next;
    localStorage.setItem('prd-theme', next);
    $('themeIcon').textContent = next === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
}

// Apply saved or preferred theme on load
(function initTheme() {
    const saved    = localStorage.getItem('prd-theme');
    const preferred = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    const theme    = saved || preferred;
    document.documentElement.dataset.theme = theme;
    $('themeIcon').textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
})();

// â”€â”€ Template select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectTpl(card) {
    document.querySelectorAll('.ttab').forEach(c => c.classList.remove('active'));
    card.classList.add('active');
    fmt = card.dataset.format;
}

// â”€â”€ Template tooltips (JS-positioned â€” avoids sidebar overflow clipping) â”€
(function initTooltips() {
    const tip = $('gTooltip');
    let hideTimer;

    document.querySelectorAll('.ttab[data-tip]').forEach(tab => {
        tab.addEventListener('mouseenter', () => {
            clearTimeout(hideTimer);
            tip.textContent = tab.dataset.tip;
            tip.classList.remove('show');
            tip.style.visibility = 'hidden';
            tip.style.display = 'block';

            requestAnimationFrame(() => {
                const tabRect = tab.getBoundingClientRect();
                const tipRect = tip.getBoundingClientRect();

                // Center above the tab
                let left = tabRect.left + tabRect.width / 2 - tipRect.width / 2;
                let top  = tabRect.top - tipRect.height - 12;

                // Clamp horizontally to viewport with padding
                const pad = 10;
                left = Math.max(pad, Math.min(left, window.innerWidth - tipRect.width - pad));

                // Flip below if not enough room above
                if (top < 8) top = tabRect.bottom + 12;

                // Position caret relative to tooltip
                const caretX = (tabRect.left + tabRect.width / 2) - left;
                tip.style.setProperty('--caret-x', caretX + 'px');
                tip.style.left = left + 'px';
                tip.style.top  = top + 'px';
                tip.style.visibility = 'visible';
                tip.classList.add('show');
            });
        });

        tab.addEventListener('mouseleave', () => {
            hideTimer = setTimeout(() => {
                tip.classList.remove('show');
                setTimeout(() => { tip.style.display = 'none'; }, 150);
            }, 80);
        });
    });
})();

// â”€â”€ Error helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showErr(msg) {
    $('errMsg').textContent = msg;
    $('errBanner').classList.add('on');
    $('errBanner').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
function clearErr() { $('errBanner').classList.remove('on'); }

// â”€â”€ Image upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function initUpload() {
    const zone  = $('uploadZone');
    const input = $('imageInput');

    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
    zone.addEventListener('drop', e => {
        e.preventDefault();
        zone.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    });
    input.addEventListener('change', e => { handleFiles(e.target.files); input.value = ''; });
})();

const ALLOWED_TYPES = ['image/jpeg','image/png','image/gif','image/webp'];

function handleFiles(files) {
    for (const file of Array.from(files)) {
        if (!ALLOWED_TYPES.includes(file.type)) {
            showErr(`Unsupported file type: ${file.name}. Use JPG, PNG, GIF or WebP.`);
            continue;
        }
        if (uploadedImages.length >= 5) { showErr('Maximum 5 images allowed.'); break; }
        if (file.size > 5 * 1024 * 1024) { showErr(`${file.name} exceeds 5 MB limit.`); continue; }

        const reader = new FileReader();
        reader.onload = e => {
            const [, base64] = e.target.result.split(',');
            uploadedImages.push({ data: base64, media_type: file.type, name: file.name, preview: e.target.result });
            renderPreviews();
        };
        reader.readAsDataURL(file);
    }
}

function removeImage(idx) {
    uploadedImages.splice(idx, 1);
    renderPreviews();
}

function renderPreviews() {
    const grid    = $('previewGrid');
    const counter = $('uploadCounter');

    if (uploadedImages.length === 0) {
        grid.classList.remove('visible');
        counter.classList.remove('visible');
        grid.innerHTML = '';
        return;
    }

    counter.textContent = `${uploadedImages.length} / 5 images attached`;
    counter.classList.add('visible');
    grid.classList.add('visible');
    grid.innerHTML = uploadedImages.map((img, i) => `
        <div class="preview-item">
            <img src="${img.preview}" alt="${img.name}" />
            <button class="preview-remove" onclick="removeImage(${i})" title="Remove">Ã—</button>
            <div class="preview-name">${img.name}</div>
        </div>
    `).join('');
}

// â”€â”€ Generate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generate() {
    if (busy) return;

    const inputs = {
        product_name:       val('f_name'),
        problem_statement:  val('f_problem'),
        target_users:       val('f_users'),
        proposed_solution:  val('f_solution'),
        business_goals:     val('f_goals'),
        timeline:           val('f_timeline'),
        additional_context: val('f_context'),
        format_type:        fmt,
        model:              val('f_model'),
        images:             uploadedImages.map(({ data, media_type }) => ({ data, media_type })),
    };

    const required = {
        product_name:      'Product Name',
        problem_statement: 'Problem Statement',
        target_users:      'Target Users',
        proposed_solution: 'Proposed Solution',
    };
    const missing = Object.entries(required).filter(([k]) => !inputs[k]).map(([,lbl]) => lbl);
    if (missing.length) { showErr('Please fill in: ' + missing.join(', ')); return; }

    clearErr();
    startUI(inputs.model, inputs.images.length);

    try {
        const res = await fetch('/generate', {
            method:  'POST',
            headers: { 'Content-Type': 'application/json' },
            body:    JSON.stringify(inputs),
        });

        if (!res.ok) {
            const e = await res.json().catch(() => ({ error: 'HTTP ' + res.status }));
            throw new Error(e.error || 'HTTP ' + res.status);
        }

        const reader  = res.body.getReader();
        const decoder = new TextDecoder();
        let   buf     = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buf += decoder.decode(value, { stream: true });
            const parts = buf.split('\n\n');
            buf = parts.pop();

            for (const part of parts) {
                const line = part.trim();
                if (!line.startsWith('data:')) continue;
                const raw = line.slice(5).trim();
                if (raw === '[DONE]') { finishUI(); return; }

                let parsed;
                try { parsed = JSON.parse(raw); } catch { continue; }
                if (parsed.error) throw new Error(parsed.error);
                if (parsed.text)  addChunk(parsed.text);
            }
        }
        finishUI();

    } catch (err) {
        showErr(err.message);
        resetUI();
    }
}

// â”€â”€ UI transitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startUI(model, imgCount) {
    busy     = true;
    markdown = '';
    t0       = Date.now();

    $('emptyState').style.display  = 'none';
    $('paperWrap').style.display   = 'block';
    $('streamView').classList.add('on');
    $('mdView').classList.remove('on');
    $('streamView').innerHTML = '<span class="cursor"></span>';

    $('chipGen').style.display  = 'flex';
    $('chipDone').style.display = 'none';

    if (imgCount > 0) {
        const chip = $('chipImgs');
        chip.style.display = 'flex';
        chip.className = 'status-chip has-imgs';
        chip.textContent = `ğŸ–¼ ${imgCount} image${imgCount > 1 ? 's' : ''} included`;
    }

    $('statsBar').classList.add('on');
    $('btnCopy').disabled = true;
    $('btnDl').disabled   = true;
    $('genBtn').disabled  = true;
    $('genBtn').classList.add('generating');
    $('genLabel').textContent = 'Generatingâ€¦';
    $('genIcon').textContent  = 'â³';

    $('sModel').textContent = model.replace('claude-', '').replace('-20251001', '');
    $('sImgs').textContent  = imgCount;
}

function addChunk(text) {
    markdown += text;
    $('streamView').textContent = markdown;
    $('streamView').innerHTML  += '<span class="cursor"></span>';
    updateStats();
    const s = $('outScroll');
    s.scrollTop = s.scrollHeight;
}

function finishUI() {
    busy = false;

    $('streamView').classList.remove('on');
    $('mdView').classList.add('on');
    $('mdContent').innerHTML = marked.parse(markdown);
    $('mdContent').querySelectorAll('input[type="checkbox"]').forEach(cb => cb.removeAttribute('disabled'));

    $('chipGen').style.display  = 'none';
    $('chipDone').style.display = 'flex';
    $('btnCopy').disabled = false;
    $('btnDl').disabled   = false;
    $('genBtn').disabled  = false;
    $('genBtn').classList.remove('generating');
    $('genLabel').textContent = 'Regenerate';
    $('genIcon').textContent  = 'â–¶';

    updateStats(true);
}

function resetUI() {
    busy = false;
    $('genBtn').disabled  = false;
    $('genBtn').classList.remove('generating');
    $('genLabel').textContent = 'Generate PRD';
    $('genIcon').textContent  = 'â–¶';
    $('chipGen').style.display = 'none';
    if (!markdown) {
        $('emptyState').style.display = '';
        $('paperWrap').style.display  = 'none';
        $('statsBar').classList.remove('on');
    }
}

function updateStats(final = false) {
    $('sChars').textContent = markdown.length.toLocaleString();
    $('sWords').textContent = (markdown.trim() ? markdown.trim().split(/\s+/).length : 0).toLocaleString();
    if (final && t0) $('sTime').textContent = ((Date.now() - t0) / 1000).toFixed(1) + 's';
}

// â”€â”€ Copy & Download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyMd() {
    navigator.clipboard.writeText(markdown).then(() => {
        const b = $('btnCopy'), orig = b.innerHTML;
        b.innerHTML = '<span>âœ“</span> Copied!';
        setTimeout(() => b.innerHTML = orig, 1600);
    });
}

function downloadMd() {
    const slug = val('f_name').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g,'') || 'prd';
    const date = new Date().toISOString().split('T')[0];
    const a = Object.assign(document.createElement('a'), {
        href:     URL.createObjectURL(new Blob([markdown], { type: 'text/markdown;charset=utf-8' })),
        download: `${slug}-${date}.md`,
    });
    a.click();
    URL.revokeObjectURL(a.href);
}

// â”€â”€ Ctrl+Enter to generate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') generate();
});
</script>
</body>
</html>
